### <center> å¼ºåŒ–å­¦ä¹ å®éªŒç¬¬ä¸‰æ¬¡å®éªŒæŠ¥å‘Š
##### <center>æ™ºèƒ½ç§‘å­¦ä¸æŠ€æœ¯ 2213530 å¼ ç¦¹è±ª
#### ä¸€ã€å®éªŒè¦æ±‚
- ä½¿ç”¨ç­–ç•¥è¿­ä»£å’Œå€¼è¿­ä»£ç®—æ³•åˆ†åˆ«æ±‚è§£ä»»æ„ä¸€ä¸ªGymç¯å¢ƒçš„æœ€ä¼˜ç­–ç•¥
#### äºŒã€å®éªŒç¯å¢ƒ
- Python 3.8
- gymnasium
#### ä¸‰ã€å®éªŒåŸç†
#### ç­–ç•¥è¿­ä»£
##### ï¼ˆ1ï¼‰æ¦‚å¿µ
&emsp;&emsp;ç­–ç•¥è¿­ä»£æ³•æ˜¯é€šè¿‡ä¸¤æ­¥å­¦ä¹ æœ€ä¼˜ç­–ç•¥ã€‚ç¬¬ä¸€æ­¥ï¼šåˆå§‹åŒ–ä¸€ä¸ªç­–ç•¥ï¼ˆæ¯”å¦‚éšæœºé€‰å–ç­–ç•¥ï¼‰ï¼Œè®¡ç®—è¯¥ç­–ç•¥çš„å€¼å‡½æ•°ï¼Œç§°ä½œç­–ç•¥è¯„ä¼°ï¼›ç¬¬äºŒæ­¥ï¼šæ ¹æ®å¾—åˆ°çš„å€¼å‡½æ•°è®¾ç½®æ–°çš„ç­–ç•¥ï¼Œç§°ä½œç­–ç•¥æ”¹è¿›ã€‚å¦‚æ­¤ä¸€ç›´åå¤è¿­ä»£ï¼Œç›´åˆ°æ”¶æ•›ï¼Œå¾—åˆ°æœ€ä¼˜ç­–ç•¥ã€‚
##### ï¼ˆ2ï¼‰æµç¨‹
- **ç­–ç•¥è¯„ä¼°**ï¼š
&emsp;&emsp;ç”¨æŸç§ç­–ç•¥ï¼ˆæ¯”å¦‚éšæœºé€‰å–åŠ¨ä½œï¼‰ï¼Œé€šè¿‡è¿­ä»£æ³•ï¼Œè®¡ç®—è¯¥é—®é¢˜çš„å„ä¸ªçŠ¶æ€çš„çŠ¶æ€ä»·å€¼ $V^\pi(s)$ã€‚å½“ç„¶å½“å‰çš„è¿™ä¸ªç­–ç•¥æœªå¿…æ˜¯æœ€ä¼˜çš„ï¼Œå¾—åˆ°çš„çŠ¶æ€å€¼ä¹Ÿæœªå¿…ç†æƒ³ï¼Œä½†å®ƒå°±æ˜¯å½“å‰è¿™ä¸ªç­–ç•¥çš„è¯„ä¼°ç»“æœã€‚è¿­ä»£å…¬å¼æ˜¯è´å°”æ›¼æ–¹ç¨‹ï¼š$$
V^\pi(s)=E_aE_s[R(s,a,s')+\gamma V^\pi(s')$$&emsp;&emsp;å¾—åˆ°çš„å„ä¸ªçŠ¶æ€å€¼å¯ç”¨ä¸€ä¸ªè¡¨æ ¼æ¥è¡¨ç¤ºã€‚
- **ç­–ç•¥æ”¹è¿›**ï¼š
&emsp;&emsp;å¯¹ä¸Šé¢å¾—åˆ°çš„ä»·å€¼è¡¨ï¼Œé€šè¿‡è¿­ä»£ï¼Œæ±‚å‡ºå„ä¸ªçŠ¶æ€så„ä¸ªåŠ¨ä½œaçš„åŠ¨ä½œå€¼å‡½æ•°å€¼$Q^\pi(s,a)$ã€‚
&emsp;&emsp;è¿­ä»£å…¬å¼ä¸ºï¼š$$Q^\pi(s,a)=E_{s'}[R(s,a,s')+\gamma V^\pi (s')]$$&emsp;&emsp;ç„¶åç”¨å¾—åˆ°çš„æ”¹è¿›ç­–ç•¥ã€‚å³å¯¹äºæ¯ä¸ªçŠ¶æ€sï¼Œé€‰æ‹©ä½¿å¾—$Q^\pi(s,a)$æœ€å¤§çš„åŠ¨ä½œaï¼Œä½œä¸ºæ–°çš„ç­–ç•¥ã€‚å³ï¼š$$\pi'(s)=argmax_aQ^\pi(s,a)$$&emsp;&emsp;è¿™æ ·å°±å¾—åˆ°äº†ä¸€ä¸ªæ–°çš„ç­–ç•¥ï¼Œç„¶åå†ç”¨è¿™ä¸ªæ–°çš„ç­–ç•¥è¿›è¡Œç­–ç•¥è¯„ä¼°ï¼Œç­–ç•¥æ”¹è¿›ï¼Œå¦‚æ­¤å¾ªç¯ï¼Œç›´åˆ°ç­–ç•¥æ”¶æ•›ã€‚
&emsp;&emsp;åˆå§‹ç­–ç•¥çš„è®¾ç½®ï¼Œå¯ä»¥é‡‡ç”¨éšæœºç­–ç•¥æˆ–è€…æŸç§å¯å‘å¼æ–¹æ³•ã€‚éšæœºç­–ç•¥æ˜¯éšæœºé€‰æ‹©åŠ¨ä½œï¼Œç›®çš„æ˜¯ç”¨å„ä¸ªåŠ¨ä½œä¸ç¯å¢ƒäº¤äº’ï¼Œæ¢ç´¢ç¯å¢ƒï¼Œè·å–æ›´å…¨é¢çš„æ•°æ®ã€‚å¯å‘å¼æ–¹æ³•ï¼Œæ˜¯é€šè¿‡ä¸“å®¶çŸ¥è¯†æˆ–ç»éªŒæŒ‡å¯¼ï¼Œé€‰æ‹©ç›¸å¯¹è¾ƒä¼˜çš„ç­–ç•¥ï¼Œå¯ä»¥åŠ å¿«æ¨¡å‹çš„æ”¶æ•›é€Ÿåº¦ã€‚
##### ï¼ˆ3ï¼‰è‹¥å¹²é—®é¢˜
- **é—®é¢˜ä¸€**ï¼šåœ¨ç­–ç•¥è¯„ä¼°æ­¥éª¤ä¸­ï¼Œå¦‚ä½•é€šè¿‡æ±‚è§£è´å°”æ›¼æ–¹ç¨‹æ¥å¾—åˆ°çŠ¶æ€å€¼$V_{\pi k}$å‘¢ï¼Ÿ$$V_{\pi k}=r_{\pi k}+\gamma P_{\pi k}v_{\pi k}$$&emsp;&emsp;**æ˜¾å¼è§£**ï¼š$$v_{\pi k}=(I-\gamma P_{\pi k})^{-1}r_{\pi k}$$&emsp;&emsp;**è¿­ä»£è§£æ³•**ï¼š$$v^{(j+1)}_{\pi k}=r_{\pi k}+\gamma P_{\pi k}v^{(j)}_{\pi k},j=0,1,2,...$$
- **é—®é¢˜äºŒ**ï¼šåœ¨ç­–ç•¥æ”¹è¿›æ­¥éª¤ä¸­ï¼Œä¸ºä»€ä¹ˆæ–°ç­–ç•¥$\pi_{k+1}$ æ¯” $\pi_{k}$ï¼Ÿ ![alt text](1.png)
- **é—®é¢˜ä¸‰**ï¼šä¸ºä»€ä¹ˆè¿™æ ·çš„è¿­ä»£ç®—æ³•æœ€ç»ˆèƒ½å¤Ÿè¾¾åˆ°æœ€ä¼˜ç­–ç•¥ï¼Ÿ
&emsp;&emsp;ç”±äºæ¯æ¬¡è¿­ä»£éƒ½ä¼šæ”¹è¿›ç­–ç•¥ï¼Œæ‰€ä»¥æˆ‘ä»¬çŸ¥é“$$v_{\pi 0}\leq v_{\pi 1}\leq v_{\pi 2}\leq ... \leq v_{\pi k} \leq ... \leq v^{*}$$&emsp;&emsp;å› æ­¤ï¼Œ$v_{\pi k}$ä¸æ–­å¢å¤§å¹¶ä¸”å°†ä¼šæ”¶æ•›ã€‚ä»éœ€è¯æ˜å®ƒæ”¶æ•›äº$v_{*}$ã€‚![alt text](2.png)
##### ï¼ˆ4ï¼‰ç®—æ³•å®ç°ï¼ˆä¼ªä»£ç ï¼‰

![alt text](3.png)![alt text](4.png)

#### å€¼è¿­ä»£
##### ï¼ˆ1ï¼‰æ¦‚å¿µ
&emsp;&emsp;å¯¹äºä¸Šé¢çš„é—®é¢˜ï¼Œä¸ä¸€å®šè®©ç­–ç•¥è¯„ä¼°å’Œç­–ç•¥æ”¹è¿›åå¤äº¤æ›¿å¤šæ¬¡ï¼Œè€Œæ˜¯ç”¨è´å°”æ›¼æœ€ä¼˜æ–¹ç¨‹ï¼Œä¸€æ¬¡æ€§ç¡®å®šå„ä¸ªçŠ¶æ€çš„$V^\pi(s)$ï¼Œå†ç”¨è¿™äº›æœ€ä¼˜çŠ¶æ€å€¼å‡½æ•°$V^\pi(s)$è®¡ç®—åŠ¨ä½œå€¼å‡½æ•°$Q(s,a)$ï¼Œæœ€åå–$Q(s,a)$æœ€å¤§çš„åŠ¨ä½œï¼Œè¿™å°±æ˜¯å€¼å‡½æ•°è¿­ä»£ç®—æ³•ã€‚
&emsp;&emsp;**å¦‚ä½•æ±‚è§£è´å°”æ›¼æœ€ä¼˜æ–¹ç¨‹ï¼Ÿ**$$v=f(v)=max_\pi(r_\pi+\gamma P_\pi v)$$&emsp;&emsp;æˆ‘ä»¬äº†è§£åˆ°å‹ç¼©æ˜ å°„å®šç†ç»™å‡ºäº†ä¸€ç§è¿­ä»£ç®—æ³•ï¼š$$v_{k+1}=f(v_k)=max_\pi (r_\pi+\gamma P_\pi v_k),k=1,2,3...$$&emsp;&emsp;å…¶ä¸­$v_0$å¯ä»¥æ˜¯ä»»æ„å€¼ã€‚
- è¯¥ç®—æ³•æœ€ç»ˆå¯ä»¥æ‰¾åˆ°æœ€ä¼˜çŠ¶æ€å€¼å’Œæœ€ä¼˜ç­–ç•¥ã€‚
- è¿™ç§ç®—æ³•è¢«ç§°ä¸º**å€¼è¿­ä»£**ï¼
##### ï¼ˆ2ï¼‰ç®—æ³•æ­¥éª¤
- **æ­¥éª¤1**ï¼šç­–ç•¥æ›´æ–°ã€‚æ­¤æ­¥éª¤æ˜¯æ±‚è§£$$\pi_{k+1}=argmax_\pi(r_\pi+\gamma P_\pi v_k)$$
- **æ­¥éª¤2**ï¼šä»·å€¼æ›´æ–°ã€‚æ­¤æ­¥éª¤æ˜¯æ±‚è§£$$v_{k+1}=r_{\pi_{k+1}}+\gamma P_{\pi_{k+1}} v_k$$
##### ï¼ˆ3ï¼‰ç®—æ³•å®ç°ï¼ˆä¼ªä»£ç ï¼‰
![alt text](5.png)

#### å››ã€å®éªŒæ­¥éª¤
#### (1)æ‰€é€‰Gymç¯å¢ƒ
- **FrozenLake-v0**
&emsp;&emsp;FrozenLakeæ˜¯ä¸€ä¸ªç®€å•çš„ç¯å¢ƒï¼Œå®ƒæ˜¯ä¸€ä¸ª4x4çš„ç½‘æ ¼ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªèµ·ç‚¹Så’Œä¸€ä¸ªç»ˆç‚¹Gã€‚å†°å—ä¸Šæœ‰ä¸€äº›æ´ï¼Œæ‰è¿›æ´é‡Œå°±å¤±è´¥äº†ã€‚åœ¨å†°é¢å¯èƒ½ä¼šæ»‘åŠ¨ï¼Œæ‰€ä»¥æœ‰æ—¶å€™å¹¶ä¸æ˜¯ç©å®¶æƒ³è¦çš„æ–¹å‘ã€‚ç©å®¶çš„ä»»åŠ¡æ˜¯æ‰¾åˆ°ä¸€æ¡è·¯å¾„ï¼Œä»èµ·ç‚¹Såˆ°ç»ˆç‚¹Gã€‚ç¯å¢ƒå¦‚ä¸‹æ‰€ç¤ºï¼š
![alt text](6.png)
- **çŠ¶æ€ç©ºé—´(S)**
&emsp;&emsp;FrozenLakeæ˜¯ä¸€ä¸ªç½‘æ ¼ä¸–ç•Œï¼Œé€šå¸¸æ˜¯4x4æˆ–8x8çš„ç½‘æ ¼ã€‚æ¯ä¸ªæ ¼å­ä»£è¡¨ä¸€ä¸ªçŠ¶æ€ï¼ŒåŒ…æ‹¬èµ·ç‚¹ï¼ˆSï¼‰ã€ç»ˆç‚¹ï¼ˆGï¼‰ã€å†°æ´ï¼ˆHï¼‰å’Œå†°å†»çš„æ¹–é¢ï¼ˆFï¼‰ã€‚æ‰€ä»¥çŠ¶æ€çš„æ€»æ•°åº”è¯¥æ˜¯ç½‘æ ¼çš„å¤§å°ï¼Œæ¯”å¦‚4x4çš„è¯å°±æ˜¯16ä¸ªçŠ¶æ€ï¼Œæ¯ä¸ªä½ç½®å¯¹åº”ä¸€ä¸ªçŠ¶æ€ã€‚
- **åŠ¨ä½œç©ºé—´(A)**
&emsp;&emsp;FrozenLakeç¯å¢ƒä¸­ï¼Œæ™ºèƒ½ä½“å¯ä»¥æ‰§è¡Œ4ä¸ªåŠ¨ä½œï¼šå‘ä¸Šã€å‘ä¸‹ã€å‘å·¦ã€å‘å³ã€‚æ‰€ä»¥åŠ¨ä½œç©ºé—´æ˜¯4ã€‚
- **å¥–åŠ±å‡½æ•°(R)**
&emsp;&emsp;â€‹æˆåŠŸå¥–åŠ±ï¼šä»…å½“åˆ°è¾¾ç›®æ ‡çŠ¶æ€Gæ—¶ï¼Œå¥–åŠ±ä¸º+1ã€‚â€‹å…¶ä»–æƒ…å†µï¼šåŒ…æ‹¬æ­£å¸¸ç§»åŠ¨ã€æ‰å…¥å†°æ´ï¼ˆHï¼‰æˆ–å¤„äºéç»ˆæ­¢çŠ¶æ€ï¼Œå¥–åŠ±å‡ä¸º â€‹0ã€‚
- **è½¬ç§»æ¦‚ç‡å‡½æ•°(P)**
    - æ»‘åŠ¨æœºåˆ¶ï¼šå½“å‚æ•° is_slippery=True æ—¶ï¼ŒåŠ¨ä½œæ‰§è¡Œå…·æœ‰éšæœºæ€§ï¼š
        - æ¯ä¸ªåŠ¨ä½œæœ‰â€‹1/3æ¦‚ç‡æ‰§è¡Œé¢„æœŸæ–¹å‘ï¼Œå‰©ä½™â€‹2/3æ¦‚ç‡å¹³å‡åˆ†é…ç»™ä¸¤ä¸ªå‚ç›´æ–¹å‘ï¼ˆå¦‚åŠ¨ä½œâ€œå·¦â€å¯èƒ½å¯¼è‡´å·¦ã€ä¸Šã€ä¸‹å„1/3æ¦‚ç‡ï¼‰ã€‚
        - è‹¥ç§»åŠ¨æ–¹å‘è¶…å‡ºç½‘æ ¼è¾¹ç•Œï¼Œåˆ™ä¿æŒåŸä½ã€‚
    - â€‹ç»ˆæ­¢çŠ¶æ€ï¼šè¿›å…¥Hæˆ–Gåï¼Œä»»ä½•åŠ¨ä½œå‡ä¿æŒå½“å‰çŠ¶æ€ä¸å˜
#### (2)ä»£ç å®ç°
#### 1.ç­–ç•¥è¿­ä»£
**è§£ææ³•ç­–ç•¥è¯„ä¼° `V_ana_evaluate()`**
```python
##########åˆ©ç”¨è§£ææ³•è¿›è¡Œç­–ç•¥è¯„ä¼°###########
def V_ana_evaluate(Pi,r_sa,P_ssa,gamma):
    P_pi = np.zeros((16, 16))
    C_pi = np.zeros((16, 1))
    for i in range(16):
        # è®¡ç®—pi(a|s)*p(s'|s,a)
        P_pi[i, :] = np.dot(np.expand_dims(Pi[i, :], axis=0), P_ssa[:, i, :]).squeeze()
        # è®¡ç®—pi(a|s)*r(s,a)
        C_pi[i, :] = np.dot(r_sa[i, :], Pi[i, :])
    ############è§£ææ³•è®¡ç®—å€¼å‡½æ•°######################
    M = np.eye(16) - P_pi *gamma
    I_M = np.linalg.inv(M)
    V = np.dot(I_M, C_pi)
    return V
```
- å®ç°åŸç†ï¼š
  - é€šè¿‡çŸ©é˜µæ±‚é€†ç›´æ¥æ±‚è§£è´å°”æ›¼æ–¹ç¨‹
  - æ„é€ é©¬å°”å¯å¤«é“¾çš„è½¬ç§»çŸ©é˜µP_piå’Œå¥–åŠ±å‘é‡C_pi
  - è®¡ç®—å…¬å¼ï¼š$V = (I - P_{pi} * gamma)^{-1} * C_{pi}$
- å…³é”®æ­¥éª¤ï¼š
  - è®¡ç®—ç­–ç•¥ç›¸å…³çš„è½¬ç§»çŸ©é˜µP_piï¼ˆ16x16ï¼‰
  - è®¡ç®—ç­–ç•¥ç›¸å…³çš„æœŸæœ›å¥–åŠ±C_piï¼ˆ16x1ï¼‰
  - æ„é€ ç³»æ•°çŸ©é˜µ$M = I - \gamma P_\pi$
  - çŸ©é˜µæ±‚é€†è®¡ç®—å€¼å‡½æ•°

**æ•°å€¼è¿­ä»£æ³•ç­–ç•¥è¯„ä¼°  `V_iter_evaluate()`**
```python
##########åˆ©ç”¨æ•°å€¼è¿­ä»£æ³•è¿›è¡Œç­–ç•¥è¯„ä¼°###########
def V_iter_evaluate(Pi,r_sa,P_ssa,gamma,V_init=np.zeros((16,1))):
    # åˆå§‹åŒ–å½“å‰å€¼å‡½æ•°
    V_cur = V_init
    #è®¡ç®—C_piå’ŒP_pi
    P_pi = np.zeros((16, 16))
    C_pi = np.zeros((16, 1))
    for i in range(16):
        # è®¡ç®—pi(a|s)*p(s'|s,a)
        P_pi[i, :] = np.dot(np.expand_dims(Pi[i, :], axis=0), P_ssa[:, i, :]).squeeze()
        # è®¡ç®—pi(a|s)*r(s,a)
        C_pi[i, :] = np.dot(r_sa[i, :], Pi[i, :])
    V_next = C_pi + np.dot(P_pi, V_cur)*gamma
    # è®¡ç®—è¿­ä»£ä¸€æ¬¡çš„è¯¯å·®
    delta = np.linalg.norm(V_next - V_cur)
    num=0
    while delta > 1e-6:
        print("num=",num)
        print("V",V_cur)
        V_cur = V_next
        V_next = C_pi + np.dot(P_pi, V_cur) *gamma
        delta = np.linalg.norm(V_next - V_cur)
        num+=1
    print("num:",num)
    print("V_cur",V_cur)
    return V_cur
```
- å®ç°åŸç†ï¼š
  - é€šè¿‡è¿­ä»£æ³•æ±‚è§£è´å°”æ›¼æ–¹ç¨‹
  - æ„é€ é©¬å°”å¯å¤«é“¾çš„è½¬ç§»çŸ©é˜µP_piå’Œå¥–åŠ±å‘é‡C_pi
  - è®¡ç®—å…¬å¼ï¼š$V_{next} = C_{pi} + P_{pi} * V_{cur} * gamma$
  - è¿­ä»£æ›´æ–°å€¼å‡½æ•°ï¼Œç›´åˆ°è¯¯å·®å°äºé˜ˆå€¼
- å…³é”®æ­¥éª¤ï¼š
  - åˆå§‹åŒ–å€¼å‡½æ•°
  - è®¡ç®—ç­–ç•¥ç›¸å…³çš„P_piå’ŒC_pi
  - è¿­ä»£æ›´æ–°å€¼å‡½æ•°ç›´è‡³æ”¶æ•›ï¼ˆè¯¯å·®<1e-6ï¼‰
  - è¾“å‡ºæœ€ç»ˆæ”¶æ•›çš„å€¼å‡½æ•°

**ç­–ç•¥æ”¹è¿›æ¨¡å— `update_policy()`**
```python
#############ç­–ç•¥æ”¹è¿›æºä»£ç ##########         è´ªå©ªç­–ç•¥
def update_policy(r_sa,P_ssa,V,gamma):
    Pi_new = np.zeros((16, 4))
    Pi = np.zeros((16,4))
    # è®¡ç®—C_piå’ŒP_pi
    P_pi = np.zeros((16, 16))
    for i in range(16):
        q_sa = np.zeros((1, 4))
        for j in range(4):
            Pi[i, :] = 0
            Pi[i, j] = 1
            P_pi[i, :] = np.dot(np.expand_dims(Pi[i, :], axis=0), P_ssa[:, i, :]).squeeze()
            vi = np.dot(r_sa[i, :], Pi[i, :]) + np.dot(P_pi[i, :], V.squeeze())*gamma
            q_sa[0, j] = vi
        max_num = np.argmax(q_sa)
        Pi_new[i, max_num] = 1
    return Pi_new
```
- å®ç°åŸç†ï¼š
  - é€šè¿‡è´ªå©ªç­–ç•¥æ›´æ–°ç­–ç•¥
  - è®¡ç®—æ¯ä¸ªçŠ¶æ€ä¸‹æ‰€æœ‰åŠ¨ä½œçš„ä»·å€¼å‡½æ•°
  - é€‰æ‹©ä»·å€¼æœ€å¤§çš„åŠ¨ä½œä½œä¸ºæ–°çš„ç­–ç•¥
  - Qå€¼è®¡ç®—å…¬å¼ï¼š$Q(s,a) = r(s,a) + \gamma \sum_{s'}P(s'|s,a)V(s')$
- å…³é”®æ­¥éª¤ï¼š
  - å¯¹æ¯ä¸ªçŠ¶æ€sï¼š
    - è®¡ç®—æ¯ä¸ªåŠ¨ä½œçš„ä»·å€¼å‡½æ•°
    - é€‰æ‹©ä»·å€¼æœ€å¤§çš„åŠ¨ä½œ
  - ç”Ÿæˆæ–°çš„ç¡®å®šæ€§ç­–ç•¥çŸ©é˜µ 

**ç­–ç•¥è¿­ä»£ç®—æ³• `policy_iteration()`**
```python
###########ç­–ç•¥è¿­ä»£ç®—æ³•##########
def policy_iteration(Pi,r_sa,P_ssa,gamma):
    Pi_cur = Pi
    #ç­–ç•¥è¯„ä¼°
    V_cur = V_iter_evaluate(Pi_cur,r_sa,P_ssa,gamma)
    #V_cur = V_ana_evaluate(Pi_cur, r_sa, P_ssa,gamma)
    #ç­–ç•¥æ”¹è¿›
    Pi_new = update_policy(r_sa,P_ssa,V_cur,gamma)
    delta =  np.linalg.norm(Pi_new-Pi_cur)
    iter_num = 1
    while delta>1e-6:
        Pi_cur = Pi_new
        # ç­–ç•¥è¯„ä¼°
        V_cur = V_iter_evaluate(Pi_cur, r_sa, P_ssa,gamma,V_cur)
        #V_cur = V_ana_evaluate(Pi_cur, r_sa, P_ssa)
        # ç­–ç•¥æ”¹è¿›
        Pi_new = update_policy(r_sa, P_ssa, V_cur,gamma)
        delta = np.linalg.norm(Pi_new - Pi_cur)
        iter_num=iter_num+1
    return Pi_cur,iter_num
```
- å®ç°æµç¨‹ï¼š
while ç­–ç•¥æœªæ”¶æ•›:
    1. ç­–ç•¥è¯„ä¼°ï¼šè®¡ç®—å½“å‰ç­–ç•¥çš„å€¼å‡½æ•°V
    2. ç­–ç•¥æ”¹è¿›ï¼šç”Ÿæˆæ–°ç­–ç•¥Pi_new
    3. æ£€æŸ¥ç­–ç•¥å˜åŒ–é‡deltaæ˜¯å¦å°äºé˜ˆå€¼
#### 2.å€¼è¿­ä»£
**å€¼è¿­ä»£ä¸»å‡½æ•° `value_iteration()`**
```python
def value_iteration(Pi_0, r_sa, P_ssa, V_init, gamma=0.99, tol=1e-6):  # æ·»åŠ gammaå‚æ•°
    V_cur = V_init
    iter_num = 0
    while True:
        # å€¼å‡½æ•°æ›´æ–°
        V_next = np.zeros_like(V_cur)
        for i in range(16):
            q_values = [r_sa[i, a] + gamma * np.dot(P_ssa[a, i, :], V_cur.squeeze()) 
                       for a in range(4)]
            V_next[i] = np.max(q_values)  # ç›´æ¥å–æœ€å¤§Qå€¼
        delta = np.linalg.norm(V_next - V_cur)
        V_cur = V_next
        iter_num += 1
        if delta < tol:
            break
    # æœ€ç»ˆç­–ç•¥æå–
    Pi_optim = update_policy(r_sa, P_ssa, V_cur, gamma)
    return Pi_optim, iter_num
```
- å®ç°æµç¨‹ï¼š
  - åˆå§‹åŒ–å€¼å‡½æ•°ï¼šä»é›¶å€¼å‡½æ•°å¼€å§‹ï¼ˆV_initï¼‰
  - â€‹å€¼å‡½æ•°æ›´æ–°ï¼š
    - å¯¹æ¯ä¸ªçŠ¶æ€è®¡ç®—æ‰€æœ‰åŠ¨ä½œçš„Qå€¼
    - é€‰æ‹©æœ€å¤§Qå€¼ä½œä¸ºæ–°å€¼å‡½æ•°
  - æ”¶æ•›åˆ¤æ–­ï¼šå€¼å‡½æ•°å˜åŒ–é‡ < å®¹å·®ï¼ˆtolï¼‰
  - â€‹ç­–ç•¥æå–ï¼šåŸºäºæœ€ç»ˆå€¼å‡½æ•°ç”Ÿæˆç¡®å®šæ€§ç­–ç•¥

**ç­–ç•¥ç”Ÿæˆå‡½æ•° `update_policy()`**
```python
def update_policy(r_sa, P_ssa, V, gamma=0.99):  # æ·»åŠ gammaå‚æ•°
    Pi_new = np.zeros((16, 4))
    for i in range(16):
        q_sa = np.zeros(4)
        for j in range(4):
            # ç›´æ¥è®¡ç®—æ¯ä¸ªåŠ¨ä½œçš„Qå€¼
            P_pi = P_ssa[j, i, :]  # åŠ¨ä½œjçš„è½¬ç§»æ¦‚ç‡
            q_sa[j] = r_sa[i, j] + gamma * np.dot(P_pi, V.squeeze())  # æ·»åŠ gamma
        max_num = np.argmax(q_sa)
        Pi_new[i, max_num] = 1
    return Pi_new
```
- å®ç°åŸç†ï¼š
    - åŸºäºå€¼å‡½æ•°Vè®¡ç®—Qå€¼çŸ©é˜µ
    - å¯¹æ¯ä¸ªçŠ¶æ€é€‰æ‹©æœ€å¤§Qå€¼å¯¹åº”çš„åŠ¨ä½œ
    - ç”Ÿæˆç¡®å®šæ€§ç­–ç•¥çŸ©é˜µ

#### 3.è¾…åŠ©åŠŸèƒ½æ¨¡å—
**æˆåŠŸç‡æµ‹è¯• `test_policy()`**
```python
def test_policy(policy, num_episodes=1000):
    # åˆ›å»ºæ— æ¸²æŸ“çš„æµ‹è¯•ç¯å¢ƒï¼ˆå‚æ•°ä¸è®­ç»ƒç¯å¢ƒä¿æŒä¸€è‡´ï¼‰
    test_env = gym.make('FrozenLake-v1', 
                      is_slippery=True,
                      render_mode=None).unwrapped
    success_count = 0 
    for _ in range(num_episodes):
        state, _ = test_env.reset()
        done = False
        while not done:
            action = np.argmax(policy[state])
            next_state, reward, done, truncated, _ = test_env.step(action)
            state = next_state
            # åˆ¤æ–­æ˜¯å¦æˆåŠŸåˆ°è¾¾ç›®æ ‡
            if done and reward == 1:
                success_count += 1
                break
    test_env.close()
    return success_count / num_episodes
```
- æµ‹è¯•é€»è¾‘ï¼š
    - åˆ›å»ºç‹¬ç«‹æµ‹è¯•ç¯å¢ƒï¼ˆæ— æ¸²æŸ“ï¼‰
    - æ‰§è¡Œç­–ç•¥1000æ¬¡ç»Ÿè®¡æˆåŠŸæ¬¡æ•°
    - æˆåŠŸæ ‡å‡†ï¼šè·å¾—æœ€ç»ˆå¥–åŠ±1

**ç­–ç•¥å¯è§†åŒ–  `visualize_policy()`**
```python
def visualize_policy(policy, env):
    # è·å–ç¯å¢ƒå¸ƒå±€æè¿°
    desc = env.unwrapped.desc  # 4x4çš„å­—ç¬¦çŸ©é˜µ
    # åŠ¨ä½œåˆ°ç®­å¤´çš„æ˜ å°„
    arrow_map = {
        0: 'â†',  # å·¦
        1: 'â†“',  # ä¸‹
        2: 'â†’',  # å³
        3: 'â†‘'   # ä¸Š
    }
    # æ„å»ºå¯è§†åŒ–çŸ©é˜µ
    grid = []
    for row in range(4):
        current_row = []
        for col in range(4):
            state = row * 4 + col
            cell_char = desc[row, col].decode('utf-8')
            
            # å¤„ç†ç‰¹æ®Šå•å…ƒæ ¼
            if cell_char == 'H':
                current_row.append('â›³')  # å†°æ´
            elif cell_char == 'G':
                current_row.append('ğŸ¯')  # ç›®æ ‡
            else:
                # è·å–è¯¥çŠ¶æ€çš„æœ€ä¼˜åŠ¨ä½œ
                action = np.argmax(policy[state])
                current_row.append(arrow_map[action])
        grid.append(current_row)
    # æ‰“å°å¯è§†åŒ–ç»“æœ
    print("\næœ€ä¼˜ç­–ç•¥å¯è§†åŒ–ï¼š")
    print("+" + "-"*13 + "+")
    for i, row in enumerate(grid):
        print("| " + " | ".join(row) + " |")
        if i < 3: 
            print("|" + "----+---+---+----" + "|")
    print("+" + "-"*13 + "+")
```
- å¯è§†åŒ–ç¬¦å·ï¼š
    - å†°æ´ï¼šâ›³
    - ç›®æ ‡ï¼šğŸ¯
    - åŠ¨ä½œç®­å¤´ï¼šâ† â†“ â†’ â†‘

#### äº”ã€å®éªŒç»“æœå±•ç¤º
##### 1.ç­–ç•¥è¿­ä»£è¾“å‡ºç»“æœå±•ç¤º
![alt text](7.png)
![alt text](8.png)
##### 2.å€¼è¿­ä»£è¾“å‡ºç»“æœå±•ç¤º
![alt text](7.png)
![alt text](9.png)
##### 3.è¾“å‡ºç»“æœçŸ©é˜µ
| $\gamma$ | è¿­ä»£æ–¹æ³• | æˆåŠŸç‡/% | è¿­ä»£æ¬¡æ•° |
|--------------|------------------------|----------------------------|----------------------------|
|    1     | ç­–ç•¥è¿­ä»£ |   82.7   |    3     |
|          |  å€¼è¿­ä»£  |   80.4   |   458    |
|   0.9    | ç­–ç•¥è¿­ä»£ |   77.4   |    3     |
|          |  å€¼è¿­ä»£  |   78.7   |    83    |
|   0.8    | ç­–ç•¥è¿­ä»£ |   44.1   |    3     |
|          |  å€¼è¿­ä»£  |   45.1   |    43    |
|   0.5    | ç­–ç•¥è¿­ä»£ |   47.6   |    3     |
|          |  å€¼è¿­ä»£  |   43.7   |    17    |
|   0.3    | ç­–ç•¥è¿­ä»£ |   43.3   |    3     |
|          |  å€¼è¿­ä»£  |   45.4   |    11    |
|    0     | ç­–ç•¥è¿­ä»£ |    0     |    3     |
|          |  å€¼è¿­ä»£  |    0     |    2     |
##### 4.ç»“è®º
| ç‰¹å¾         | ç­–ç•¥è¿­ä»£               | å€¼è¿­ä»£                     |
|--------------|------------------------|----------------------------|
| ä¸»è¦ç›®æ ‡     | ç›´æ¥ä¼˜åŒ–ç­–ç•¥           | ç›´æ¥ä¼˜åŒ–å€¼å‡½æ•°             |
| ç®—æ³•æµç¨‹     | äº¤æ›¿æ‰§è¡Œç­–ç•¥è¯„ä¼° + ç­–ç•¥æ”¹è¿› | æŒç»­æ›´æ–°å€¼å‡½æ•° â†’ æœ€åæå–ç­–ç•¥ |
| æ›´æ–°æ–¹å¼     | ç­–ç•¥æ”¶æ•›åæ‰æ›´æ–°å€¼å‡½æ•° | æ¯æ¬¡è¿­ä»£éƒ½æ›´æ–°å€¼å‡½æ•°       |
| è®¡ç®—å¤æ‚åº¦   | O(nÂ³Â·m)ï¼ˆéœ€çŸ©é˜µæ±‚é€†ï¼‰  | O(nÂ²Â·k)ï¼ˆå‘é‡åŒ–è®¡ç®—æ›´å¿«ï¼‰  |
| å†…å­˜æ¶ˆè€—     | éœ€å­˜å‚¨ç­–ç•¥çŸ©é˜µå’Œå€¼å‡½æ•° | åªéœ€å­˜å‚¨å€¼å‡½æ•°             |
| æ”¶æ•›é€Ÿåº¦     | ç­–ç•¥ç©ºé—´å°æ—¶æ›´å¿«ï¼ˆçº¦5-10æ¬¡è¿­ä»£ï¼‰ | éœ€è¦æ›´å¤šè¿­ä»£ï¼ˆçº¦100-200æ¬¡ï¼‰ |
| ä¸­é—´ç­–ç•¥     | æ¯ä¸ªè¿­ä»£éƒ½æœ‰å®Œæ•´ç­–ç•¥   | åªæœ‰æœ€ç»ˆç­–ç•¥æœ‰æ„ä¹‰         |
| é€‚ç”¨åœºæ™¯     | å°è§„æ¨¡çŠ¶æ€ç©ºé—´ï¼ˆå¦‚4x4ç½‘æ ¼ï¼‰ | å¤§è§„æ¨¡çŠ¶æ€ç©ºé—´ï¼ˆå¦‚8x8ç½‘æ ¼ï¼‰ |
